<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Метрополитен</title>

<style>
  :root{
    --bg:#0f0f0f;
    --panel:#111214cc;
    --accent:#00c2a8;
    --muted:#9aa0a6;
    --font-sans: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:var(--font-sans);}
  .app {display:flex;gap:16px;height:100vh;padding:16px;box-sizing:border-box;}
  .map-wrap {
    flex:1; position:relative; overflow:hidden;
    background:#0d0e10; border-radius:14px;
    box-shadow:0 0 25px rgba(0,0,0,.6);
  }
  #bgImage {
    position:absolute; inset:0;
    width:100%; height:100%; object-fit:contain; pointer-events:none;
  }
  svg {width:100%;height:100%;position:absolute;top:0;left:0;user-select:none;touch-action:none;}
  .panel {
    width:330px; background:var(--panel); padding:14px; border-radius:14px;
    display:flex;flex-direction:column; gap:12px;
  }
  .row{display:flex; gap:10px;}
  .select{flex:1;padding:8px;border-radius:10px;background:#0c0c0c;color:#fff;border:1px solid #333;}
  .btn{padding:10px;border:0;border-radius:10px;background:var(--accent);color:#04110f;font-weight:700;cursor:pointer;}
  .btn2{padding:10px;border:0;border-radius:10px;background:#444;color:#fff;cursor:pointer;}
  .timeBox{background:#00000050;padding:10px;border-radius:10px;text-align:center;font-size:17px;}
  .legend{display:flex;flex-wrap:wrap;gap:8px;font-size:13px;color:var(--muted);}
  .legend .item{display:flex;gap:8px;align-items:center}
  .legend .dot{width:16px;height:6px;border-radius:4px}
  .station{fill:#fff;stroke:#111;stroke-width:1.5;cursor:pointer;}
  .station-small{r:4.5;}
  .station-transfer{r:6.5;}
  .station-label{font-size:12px;fill:#e8eef1;font-weight:600;pointer-events:none;}
  .line{fill:none;stroke-width:6;stroke-linecap:round;stroke-linejoin:round;}
  .route-line{stroke:#fff;stroke-width:9;fill:none;opacity:.95;}
</style>
</head>

<body>
<div class="app">

  <!-- ========= MAP ========= -->
  <div class="map-wrap">
    <!-- Загружай свою карту сюда: /images/map.png -->
    <img id="bgImage" src="images/map.png" alt="">
    <svg id="mapSvg" viewBox="-200 -200 1200 1200">
      <g id="mapGroup"></g>
      <g id="routeGroup"></g>
    </svg>
  </div>

  <!-- ========= PANEL ========= -->
  <div class="panel">

    <div class="row">
      <select id="fromSel" class="select"></select>
      <select id="toSel" class="select"></select>
    </div>

    <button class="btn" id="goBtn">Маршрут</button>
    <button class="btn2" id="clrBtn">Очистить</button>

    <div id="timeBox" class="timeBox">Время: —</div>

    <div id="legend" class="legend"></div>
  </div>
</div>

<script>
/* ====================================================
   ДАННЫЕ СТАНЦИЙ
   ==================================================== */
const stations = {
  s1:{name:"Академическая",x:400,y:400},
  s2:{name:"Профсоюзная",x:400,y:520},
  s3:{name:"Новые Черёмушки",x:400,y:660},
  s4:{name:"Калужская",x:400,y:820},
  s5:{name:"Крымская",x:320,y:480},
  s7:{name:"Столица",x:400,y:50}
};

const lines = [
  {name:"Оранжевая", color:"#ff8a00", stations:["s1","s2","s3","s4"]},
  {name:"Красная", color:"#d62828", stations:["s7","s1"]},
  {name:"Серая", color:"#222222", stations:["s5","s1"]}
];

const timePerEdge = 2;
const transferPenalty = 3;


/* ====================================================
   ГРАФ
   ==================================================== */
const graph = {};
Object.keys(stations).forEach(id => graph[id]=new Set());

lines.forEach(l=>{
  for(let i=0;i<l.stations.length-1;i++){
    const a=l.stations[i], b=l.stations[i+1];
    graph[a].add(b); graph[b].add(a);
  }
});


/* ====================================================
   ОТРИСОВКА
   ==================================================== */
const svgNS="http://www.w3.org/2000/svg";
const mapGroup=document.getElementById("mapGroup");

function draw(){
  mapGroup.innerHTML="";

  lines.forEach(l=>{
    const p=document.createElementNS(svgNS,"path");
    p.classList.add("line");
    p.setAttribute("stroke",l.color);
    p.setAttribute("d", makePath(l.stations));
    mapGroup.appendChild(p);
  });

  Object.keys(stations).forEach(id=>{
    const st=stations[id];
    const g=document.createElementNS(svgNS,"g");
    g.setAttribute("transform",`translate(${st.x},${st.y})`);
    g.dataset.id=id;

    const count=lines.filter(L=>L.stations.includes(id)).length;

    const c=document.createElementNS(svgNS,"circle");
    c.classList.add("station");
    c.classList.add(count>1 ? "station-transfer":"station-small");
    g.appendChild(c);

    const t=document.createElementNS(svgNS,"text");
    t.classList.add("station-label");
    t.setAttribute("x",12);
    t.setAttribute("y",4);
    t.textContent=st.name;
    g.appendChild(t);

    g.addEventListener("click",()=> stationClick(id));
    mapGroup.appendChild(g);
  });

  fillSelectors();
  fillLegend();
}

function makePath(idList){
  const pts=idList.map(id=>stations[id]);
  let d=`M ${pts[0].x} ${pts[0].y}`;
  for(let i=1;i<pts.length;i++)
    d+=` L ${pts[i].x} ${pts[i].y}`;
  return d;
}

draw();


/* ====================================================
   SELECTS
   ==================================================== */
const fromSel=document.getElementById("fromSel");
const toSel=document.getElementById("toSel");

function fillSelectors(){
  fromSel.innerHTML="";
  toSel.innerHTML="";
  Object.keys(stations).forEach(id=>{
    fromSel.add(new Option(stations[id].name,id));
    toSel.add(new Option(stations[id].name,id));
  });
}

let clickCount=0;
function stationClick(id){
  if(clickCount%2===0) fromSel.value=id;
  else toSel.value=id;
  clickCount++;
}


/* ====================================================
   ЛЕГЕНДА
   ==================================================== */
function fillLegend(){
  const L=document.getElementById("legend");
  L.innerHTML="";
  lines.forEach(l=>{
    const item=document.createElement("div"); item.className="item";
    const dot=document.createElement("div"); dot.className="dot"; dot.style.background=l.color;
    const lbl=document.createElement("span"); lbl.textContent=l.name;
    item.append(dot,lbl); L.append(item);
  });
}


/* ====================================================
   BFS + ВРЕМЯ
   ==================================================== */
function findRoute(start,end){
  const q=[start];
  const prev={}; prev[start]=null;

  while(q.length){
    const u=q.shift();
    for(const v of graph[u]){
      if(prev[v]===undefined){
        prev[v]=u;
        q.push(v);
        if(v===end){
          const path=[];
          let cur=v;
          while(cur){ path.push(cur); cur=prev[cur]; }
          return path.reverse();
        }
      }
    }
  }
  return null;
}

function sameLine(a,b,c){
  return lines.some(l=>{
    const s=l.stations;
    return s.includes(a) && s.includes(b) && s.includes(c);
  });
}

function computeTime(path){
  let time = (path.length-1)*timePerEdge;
  for(let i=1;i<path.length-1;i++){
    if(!sameLine(path[i-1],path[i],path[i+1]))
      time += transferPenalty;
  }
  return time;
}


/* ====================================================
   ОТРИСОВКА МАРШРУТА
   ==================================================== */
const routeGroup=document.getElementById("routeGroup");

function drawRoute(path){
  routeGroup.innerHTML="";
  if(!path || path.length<2) return;

  const p=document.createElementNS(svgNS,"path");
  p.classList.add("route-line");
  p.setAttribute("d", makePath(path));
  routeGroup.appendChild(p);
}


/* ====================================================
   КНОПКИ
   ==================================================== */
document.getElementById("goBtn").onclick = ()=>{
  const A=fromSel.value;
  const B=toSel.value;
  if(!A || !B) return;

  const route=findRoute(A,B);
  if(!route){ alert("Маршрут не найден!"); return; }

  drawRoute(route);

  const minutes = computeTime(route);
  document.getElementById("timeBox").textContent="Время: " + minutes + " мин";
};

document.getElementById("clrBtn").onclick = ()=>{
  routeGroup.innerHTML="";
  document.getElementById("timeBox").textContent="Время: —";
};

</script>
</body>
</html>
